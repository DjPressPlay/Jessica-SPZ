<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jessica-SPZ ‚Ä¢ SporeZ Link Fusion</title>
  <style>
    :root{
      --bg:#070b10; --panel:#0c121a; --muted:#8aa2bc;
      --line:#102534; --glow1:#00f0ff; --glow2:#00ff88; --iris:#7b2ff7; --white:#e8f1ff;
      --accent:#70ffe0; --danger:#ff4d6d; --ok:#66ff99;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1400px 900px at 50% -10%, #0e1824 0%, var(--bg) 60%),
        linear-gradient(180deg, rgba(0,0,0,.4), transparent 40%);
      color:var(--white); font:14px/1.5 system-ui,Segoe UI,Roboto,Inter,Arial;
      display:flex; align-items:flex-start; justify-content:center;
    }

    /* Global holo gradient animation */
    @keyframes iridescentMove {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* Generic holo-border helper */
    .holo {
      position:relative; border-radius:16px; border:2px solid transparent; background-clip:padding-box;
    }
    .holo::before{
      content:""; position:absolute; inset:-2px; border-radius:inherit; padding:2px;
      background: linear-gradient(135deg, var(--glow1), var(--iris), var(--glow2));
      background-size:300% 300%; animation: iridescentMove 8s ease infinite;
      -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite:xor; mask-composite:exclude; pointer-events:none;
    }

    .wrap{width:min(1240px,96vw); padding:24px 16px 32px}
    header{display:grid; gap:8px; place-items:center; text-align:center; margin-bottom:18px}
    h1{
      margin:0;
      font-size:26px; letter-spacing:.6px; text-transform:uppercase;
      background:linear-gradient(90deg,var(--glow1),var(--iris),var(--glow2));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-align:center;
      filter: drop-shadow(0 2px 10px rgba(0,255,200,.12));
    }
    .sub{color:var(--muted); text-align:center}

    /* Two-pane layout: narrow sticky left, big right */
    .grid{
      display:grid;
      grid-template-columns: minmax(300px, 380px) 1fr;
      gap:18px;
      align-items:start;
    }

    /* Panels */
    .panel{
      background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.00));
      border:1px solid var(--line); border-radius:16px; padding:14px;
      box-shadow:
        0 0 0 1px rgba(0,0,0,.35),
        0 12px 32px rgba(0,0,0,.45);
    }
    .panel h2{
      margin:0 0 12px; font-size:12px; font-weight:800; letter-spacing:.26px; text-transform:uppercase;
      color:var(--muted); text-align:center;
    }

    /* Left controls: sticky + scrollable */
    .controls{display:grid; gap:12px; position:sticky; top:12px; max-height:calc(100vh - 24px); overflow:auto}
    textarea, input[type="text"]{
      width:100%; background:#0a1118; color:var(--white); border:1px solid #142131; border-radius:12px;
      padding:12px 12px; outline:none; font:13px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.35);
    }
    textarea{min-height:120px; resize:vertical}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:center}
    .row > * { flex:1 1 auto }

    .pill{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-size:12px;
      border:1px solid #173346; background:#0c1720; color:var(--muted); justify-content:center
    }

    .btn{
      appearance:none; border:1px solid #143244; background:#0e1b26; color:var(--white);
      padding:10px 14px; border-radius:12px; font-weight:800; letter-spacing:.25px; cursor:pointer;
      transition:.18s transform ease,.18s box-shadow ease,.18s border-color ease; text-align:center;
    }
    .btn:hover{transform:translateY(-1px); box-shadow:0 10px 24px rgba(0,0,0,.35); border-color:#18465f}
    .btn.primary{
      background:linear-gradient(90deg,var(--glow1),var(--iris),var(--glow2)); color:#001b1f; border-color:transparent;
      box-shadow: 0 0 14px rgba(0,240,255,.28), 0 0 28px rgba(0,255,136,.18);
    }

    .stack{display:grid; gap:10px}
    pre{
      margin:0; max-height:160px; overflow:auto; background:#071018; color:#c6ecff;
      border:1px solid #0f2536; border-radius:12px; padding:10px; font-size:12px;
    }

    /* Right: live preview area */
    .preview{
      display:grid; gap:14px; padding:10px; border-radius:18px;
      background: rgba(7, 12, 18, .65);
      box-shadow: 0 0 40px rgba(0, 240, 255, 0.07);
      border:1px solid rgba(16,37,52,.8);
    }

    /* Card with holo border */
    .card{
      position:relative; border-radius:18px; padding:16px; overflow:hidden;
      border:2px solid rgba(255,255,255,.06);
      background:
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,0)),
        radial-gradient(100% 70% at 0% 0%, rgba(0,240,255,.08), transparent 60%),
        radial-gradient(100% 70% at 100% 0%, rgba(0,255,136,.08), transparent 60%),
        #0b1219;
      box-shadow:
        0 0 0 1px rgba(0,0,0,.55) inset,
        0 30px 50px rgba(0,0,0,.35),
        0 0 60px rgba(0,240,255,.05);
    }
    .card.holo::before{ /* holo gradient frame for card */
      content:""; position:absolute; inset:-2px; border-radius:20px; padding:2px;
      background: linear-gradient(135deg, var(--glow1), var(--iris), var(--glow2));
      background-size:300% 300%; animation: iridescentMove 10s ease infinite;
      -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite:xor; mask-composite:exclude; pointer-events:none; opacity:.85;
    }

    .card .frame{ position:absolute; inset:0; pointer-events:none; background:conic-gradient(from 0deg, rgba(0,240,255,.2), rgba(0,255,136,.2), rgba(0,240,255,.2)); mask:linear-gradient(#000,transparent 30%); opacity:.12; }

    .hero{display:grid; gap:10px; place-items:center; text-align:center}
    .hero .img-wrap{ width:100%; border-radius:16px; }
    .hero .img-wrap.holo::before{ opacity:.9; }
    .hero img{
      width:100%; height:44vh; max-height:320px; object-fit:cover; border-radius:14px; display:block;
      background:linear-gradient(135deg,#0d1720,#0a1219);
      border:1px solid rgba(255,255,255,.06);
      box-shadow: 0 8px 30px rgba(0,0,0,.35);
    }
    .hero h3{margin:6px 0 0; font-size:20px; letter-spacing:.2px}
    .hero p{margin:0; color:var(--muted); font-size:13px}
    .cta{margin-top:8px}
    .cta a{
      display:inline-block; padding:10px 14px; border-radius:999px; text-decoration:none; font-weight:800;
      color:#001b1f; background:linear-gradient(90deg,var(--glow1),var(--iris),var(--glow2));
      border:0; box-shadow:0 8px 24px rgba(0,255,200,.18);
    }

    .columns{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px}
    .box{ border:1px solid #142131; border-radius:14px; padding:12px; background:#0c141caa; }
    .box.holo::before{opacity:.5}

    .products{display:grid; grid-template-columns:repeat(auto-fill,minmax(170px,1fr)); gap:12px}

    /* Product card with iridescent outline */
    .prod{
      position:relative; border-radius:12px; padding:10px; background:#0b131b;
      display:grid; gap:8px; text-align:center; border:2px solid transparent; background-clip:padding-box;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.45), 0 10px 26px rgba(0,0,0,.28);
    }
    .prod::before{
      content:""; position:absolute; inset:-2px; border-radius:14px; padding:2px;
      background: linear-gradient(135deg, var(--glow1), var(--iris), var(--glow2));
      background-size:300% 300%; animation: iridescentMove 7s ease infinite;
      -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite:xor; mask-composite:exclude; pointer-events:none;
    }

    .prod img{width:100%; height:120px; object-fit:cover; border-radius:10px; background:#0d1924; display:block; border:1px solid rgba(255,255,255,.06)}
    .prod .name{font-weight:800; letter-spacing:.2px}
    .prod .price{color:var(--ok); font-weight:800}
    .prod a{color:var(--accent); text-decoration:none; font-weight:800}

    /* --- NEW: Social Signals --- */
    .social-list{
      display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:12px;
    }
    .social-card{
      position:relative; border-radius:12px; padding:10px; background:#0b131b; display:grid; gap:8px;
      border:2px solid transparent; background-clip:padding-box;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.45), 0 10px 26px rgba(0,0,0,.28);
    }
    .social-card::before{
      content:""; position:absolute; inset:-2px; border-radius:14px; padding:2px;
      background: linear-gradient(135deg, var(--glow1), var(--iris), var(--glow2));
      background-size:300% 300%; animation: iridescentMove 8s ease infinite;
      -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite:xor; mask-composite:exclude; pointer-events:none;
    }
    .social-media{width:100%; border-radius:10px; overflow:hidden; border:1px solid rgba(255,255,255,.06); background:#0d1924}
    .social-media img{width:100%; height:150px; object-fit:cover; display:block}
    .social-media video{width:100%; height:150px; object-fit:cover; display:block}
    .social-desc{color:#c6ecff; font-size:12px}
    .social-meta{display:flex; gap:8px; flex-wrap:wrap; align-items:center; color:#8fb8cf; font-weight:700; font-size:12px}
    .social-meta .pill{background:#0e1b26; border-color:#173346; color:#8fb8cf}
    .social-react{color:#9dd8ff; font-style:italic; font-size:12px}

    footer{margin-top:10px; text-align:center; color:var(--muted); font-size:12px}
    .center{text-align:center}
    .bad{color:var(--danger)}

    @media (max-width:980px){
      .grid{grid-template-columns:1fr}
      .columns{grid-template-columns:1fr}
      .hero img{height:36vh; max-height:260px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Jessica-SPZ ‚Äî SporeZ Link Fusion</h1>
      <div class="sub">
        <span class="pill" id="sid-pill">Session: <b id="sid">‚Ä¶</b></span>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: Controls (sticky) -->
      <section class="panel controls">
        <h2>Input Links</h2>
        <textarea id="links" placeholder="Paste 1 link per line"></textarea>

        <div class="row">
          <label class="pill"><input type="radio" name="mode" value="auto" checked />&nbsp;Auto</label>
          <label class="pill"><input type="radio" name="mode" value="sell" />&nbsp;Sell</label>
          <label class="pill"><input type="radio" name="mode" value="info" />&nbsp;Info</label>
          <label class="pill"><input type="radio" name="mode" value="hybrid" />&nbsp;Hybrid</label>
        </div>

        <div class="row">
          <label class="pill"><input type="checkbox" id="defSell" checked />&nbsp;Default: Sell product</label>
          <label class="pill"><input type="checkbox" id="defInfo" />&nbsp;Default: Show info</label>
        </div>

        <div class="row">
          <input id="slug" type="text" placeholder="slug (optional, e.g. my-drop)" />
        </div>

        <div class="row">
          <button class="btn primary" id="btn-run">Crawl + Fuse</button>
          <button class="btn" id="btn-preview">Preview</button>
          <!-- Publish button removed -->
        </div>

        <div class="stack">
          <h2>Log</h2>
          <pre id="log">ready.</pre>
          <h2>Fused JSON</h2>
          <pre id="json">{}</pre>
        </div>
      </section>

      <!-- RIGHT: Live Preview -->
      <section class="panel preview">
        <h2>Live Preview</h2>
        <div class="card holo" id="card">
          <div class="frame"></div>

          <div class="hero" id="hero">
            <div class="img-wrap holo">
              <img id="heroImg" alt="Hero" />
            </div>
            <h3 id="heroTitle" class="center">Your Fused Page Will Appear Here</h3>
            <p id="heroSub" class="center">Paste links on the left and run <b>Crawl + Fuse</b>.</p>
            <div class="cta" id="heroCta"></div>
          </div>

          <div class="columns">
            <div class="box holo">
              <div class="center" style="margin-bottom:8px; color:var(--muted); font-weight:800; letter-spacing:.2px;">Products</div>
              <div class="products" id="products"></div>
            </div>
            <div class="box holo">
              <div class="center" style="margin-bottom:8px; color:var(--muted); font-weight:800; letter-spacing:.2px;">Info</div>
              <div id="info"></div>
            </div>
          </div>

          <!-- NEW: Social Signals panel -->
          <div class="box holo" style="margin-top:12px;">
            <div class="center" style="margin-bottom:8px; color:var(--muted); font-weight:800; letter-spacing:.2px;">Social Signals</div>
            <div class="social-list" id="social"></div>
          </div>

          <footer id="footer">SporeZ ‚Ä¢ Jessica-SPZ ‚Ä¢ Auto-Fusion</footer>
        </div>
      </section>
    </div>
  </div>

  <script>
    // --- Session ID (SporeZ-style) ---
    function getOrCreateSessionId() {
      try {
        const k = "spz_session_id";
        let v = sessionStorage.getItem(k);
        if (!v) { v = "spz_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,8); sessionStorage.setItem(k, v); }
        return v;
      } catch { return "spz_local_"+Date.now(); }
    }
    const SID = getOrCreateSessionId();
    document.getElementById("sid").textContent = SID;

    // --- UI refs ---
    const elLinks = document.getElementById("links");
    const elLog   = document.getElementById("log");
    const elJSON  = document.getElementById("json");
    const elHeroImg = document.getElementById("heroImg");
    const elHeroTitle = document.getElementById("heroTitle");
    const elHeroSub = document.getElementById("heroSub");
    const elHeroCta = document.getElementById("heroCta");
    const elProducts = document.getElementById("products");
    const elInfo = document.getElementById("info");
    const elSocial = document.getElementById("social");
    const elFooter = document.getElementById("footer");

    const $ = (s) => document.querySelector(s);
    const getMode = () => (document.querySelector('input[name="mode"]:checked')?.value || "auto");
    const getDefaults = () => ({ sell: $('#defSell').checked, info: $('#defInfo').checked });

    function log(msg, isErr=false){
      elLog.textContent += "\n" + (isErr ? "‚õî " : "‚Ä¢ ") + msg;
      elLog.scrollTop = elLog.scrollHeight;
    }

    async function postJSON(path, body){
      const res = await fetch(path, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body || {}) });
      if(!res.ok){ const t = await res.text().catch(()=> ""); throw new Error(`HTTP ${res.status} ${t}`); }
      return res.json();
    }

    // State
    let fused = null;
    let social = [];

    // Fallback sample
    const sampleFused = {
      mode:"hybrid",
      slug:"sample-" + Date.now().toString(36),
      hero:{ title:"Zetsu-Grade Fusion Page", subtitle:"Auto-built from your links", image:"", ctaText:"Claim Your Drop", ctaLink:"#"},
      products:[
        {name:"Holo Tee", price:"$29", link:"#", description:"Shimmer print ‚Ä¢ Limited"},
        {name:"Z-Cap", price:"$19", link:"#", description:"Low-profile ‚Ä¢ Night mode"},
        {name:"Signal Tag", price:"$9", link:"#", description:"Metal core ‚Ä¢ NFC"}
      ],
      articles:[
        {heading:"What This Page Does", content:"Jessica-SPZ crawls your links, extracts key info and products, and fuses it into a single, market-ready SporeZ page."},
        {heading:"How It Chooses Layout", content:"Mode: Auto (or Sell/Info/Hybrid). Defaults guarantee a complete page even if a site blocks scraping."}
      ],
      media:[]
    };

    // NEW: Sample social (only used if backend not available)
    const sampleSocial = [
      {
        url:"https://instagram.com/p/xyz",
        title:"Sample IG Post",
        description:"Behind the scenes of the drop.",
        image:"https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=800&auto=format&fit=crop",
        likes:2555, comments:616, shares:120, author:"artworqq", platform:"Instagram"
      },
      {
        url:"https://twitter.com/x/status/123",
        title:"Teaser",
        description:"Sneak peek ‚Äî holo print in motion.",
        video:"", // leave empty to show just text
        likes:984, comments:112, shares:89, author:"sporez", platform:"X"
      }
    ];

    async function runCrawlAndFuse(){
      try{
        elLog.textContent = "running‚Ä¶";
        const links = elLinks.value.split(/\n+/).map(s=>s.trim()).filter(Boolean);
        if(!links.length){ log("Add at least one link.", true); return; }

        log("Crawling links‚Ä¶");
        const crawl = await postJSON("/api/crawl", { links, session: SID });

        log("Fusing content‚Ä¶");
        fused = await postJSON("/api/fuse", { results: (crawl.results || []), mode: getMode(), defaults: getDefaults(), session: SID });
        elJSON.textContent = JSON.stringify(fused, null, 2);
        log("Fusion complete.");

        // --- NEW: Social meta enrichment ---
        log("Fetching social metadata‚Ä¶");
        social = await fetchSocialMeta(links);
        log(`Social metadata ready (${social.length} items).`);

        renderPreview(fused, social);
      }catch(e){
        log("Error: " + e.message, true);
        // still render at least fallback
        renderPreview(fused || sampleFused, social || []);
      }
    }

    function ensure(v, fb){ return (v===undefined || v===null || v==="") ? fb : v; }

    // --- NEW: backend-assisted social meta fetcher (graceful fallback) ---
    async function fetchSocialMeta(links){
      try{
        const out = await postJSON("/api/social_meta", { links, session: SID });
        // Expecting [{url, title, description, image, video, likes, comments, shares, author, platform}]
        if (Array.isArray(out?.items)) return out.items.filter(Boolean);
      }catch(e){
        log("Social meta API not available, using sample.", true);
      }
      return sampleSocial;
    }

    // --- NEW: stat reaction generator ---
    function reactToStats({likes=0, comments=0, shares=0}={}){
      const opts = [
        (l,c)=> l>0 && c>0 ? `üí¨ ${c} comments and ${l} likes ‚Äî people are talking.` : null,
        (l)=> l>1000 ? `üî• This post is blowing up with ${l.toLocaleString()} likes!` : null,
        (l)=> l>0 ? `üíñ Loved by ${l.toLocaleString()} people.` : null,
        (l,c,s)=> (s||0)>0 ? `üì¢ ${s.toLocaleString()} shares spreading the signal.` : null,
        (l,c)=> c>0 ? `üëè ${c.toLocaleString()} comments ‚Äî strong engagement.` : null
      ];
      for (let i=0;i<3;i++){ // try a few random picks
        const t = opts[Math.floor(Math.random()*opts.length)];
        const r = t(likes,comments,shares);
        if (r) return r;
      }
      return (likes||comments||shares) ? `‚≠ê Nice engagement on this one.` : ``;
    }

    // --- NEW: social card renderer ---
    function socialCardNode(m){
      const div = document.createElement("div"); div.className = "social-card";
      const mediaWrap = document.createElement("div"); mediaWrap.className = "social-media";
      if (m.video){
        const v = document.createElement("video"); v.src = m.video; v.controls = true; mediaWrap.appendChild(v);
      } else if (m.image){
        const i = document.createElement("img"); i.src = m.image; i.alt = m.title || "post"; mediaWrap.appendChild(i);
      }
      const title = document.createElement("div");
      title.style.fontWeight = "800"; title.style.letterSpacing = ".2px";
      title.textContent = m.title || (m.platform ? (m.platform + " post") : "Post");

      const desc = document.createElement("div"); desc.className = "social-desc";
      desc.textContent = m.description || "";

      const meta = document.createElement("div"); meta.className = "social-meta";
      if (m.platform){ const p = document.createElement("span"); p.className="pill"; p.textContent = m.platform; meta.appendChild(p); }
      if (m.author){ const a = document.createElement("span"); a.className="pill"; a.textContent = "@" + m.author; meta.appendChild(a); }
      if (typeof m.likes === "number"){ const l = document.createElement("span"); l.className="pill"; l.textContent = `‚ù§Ô∏è ${m.likes.toLocaleString()}`; meta.appendChild(l); }
      if (typeof m.comments === "number"){ const c = document.createElement("span"); c.className="pill"; c.textContent = `üí¨ ${m.comments.toLocaleString()}`; meta.appendChild(c); }
      if (typeof m.shares === "number"){ const s = document.createElement("span"); s.className="pill"; s.textContent = `üîÅ ${m.shares.toLocaleString()}`; meta.appendChild(s); }

      const react = document.createElement("div"); react.className = "social-react";
      const rx = reactToStats({likes:m.likes, comments:m.comments, shares:m.shares});
      react.textContent = rx;

      const link = document.createElement("a");
      link.href = m.url || "#"; link.target = "_blank"; link.rel="noopener";
      link.textContent = "Open"; link.style.color = "var(--accent)"; link.style.fontWeight = "800"; link.style.textDecoration = "none";

      if (mediaWrap.childNodes.length) div.append(mediaWrap);
      div.append(title);
      if (desc.textContent) div.append(desc);
      if (meta.childNodes.length) div.append(meta);
      if (rx) div.append(react);
      if (m.url) div.append(link);
      return div;
    }

    function renderPreview(data, socialItems=[]){
      const d = data || sampleFused;
      const hero = d.hero || {};
      const prods = Array.isArray(d.products) ? d.products : [];
      const arts = Array.isArray(d.articles) ? d.articles : [];

      elHeroTitle.textContent = ensure(hero.title, "Your Fused Page");
      elHeroSub.textContent   = ensure(hero.subtitle, "Merged info + offers in one layout.");
      elHeroImg.src = hero.image || "";
      elHeroImg.style.display = hero.image ? "block" : "none";

      elHeroCta.innerHTML = "";
      if(hero.ctaText){
        const a = document.createElement("a");
        a.href = hero.ctaLink || "#"; a.textContent = hero.ctaText; a.target = "_blank";
        elHeroCta.appendChild(a);
      }

      // Products
      elProducts.innerHTML = "";
      (prods.length ? prods.slice(0,8) : (getDefaults().sell ? [
        {name:"Starter Pack", price:"$29", link:"#"},
        {name:"Mystery Drop", price:"$19", link:"#"}
      ] : [])).forEach(p=> elProducts.appendChild(prodNode(p)));

      // Info
      elInfo.innerHTML = "";
      (arts.length ? arts.slice(0,6) : (getDefaults().info ? [
        {heading:"About", content:"This section will summarize your fused links: brand purpose, key features, and how to act."}
      ] : [])).forEach(a=> elInfo.appendChild(infoNode(a)));

      // NEW: Social Signals
      elSocial.innerHTML = "";
      (Array.isArray(socialItems) ? socialItems : []).slice(0,6).forEach(s => {
        try{ elSocial.appendChild(socialCardNode(s)); }catch{}
      });

      elFooter.textContent = (d.mode ? d.mode.toUpperCase()+" ‚Ä¢ " : "") + "SporeZ ‚Ä¢ Jessica-SPZ";
    }

    function prodNode(p){
      const div = document.createElement("div"); div.className = "prod";
      const img = document.createElement("img"); img.src = p.image || ""; img.style.display = p.image ? "block" : "none";
      const name = document.createElement("div"); name.className = "name"; name.textContent = p.name || "Unnamed";
      const price = document.createElement("div"); price.className = "price"; price.textContent = p.price || "";
      const link = document.createElement("a"); link.href = p.link || "#"; link.target = "_blank"; link.textContent = "View";
      const desc = document.createElement("div"); desc.style.color = "var(--muted)"; desc.style.fontSize = "12px"; desc.textContent = p.description || "";
      div.append(img, name, price, desc, link); return div;
    }

    function infoNode(a){
      const box = document.createElement("div"); box.style.display = "grid"; box.style.gap = "6px";
      const h = document.createElement("div"); h.style.fontWeight = "800"; h.textContent = a.heading || "Info";
      const c = document.createElement("div"); c.style.whiteSpace = "pre-wrap"; c.style.color = "var(--white)"; c.textContent = a.content || "";
      box.append(h,c); return box;
    }

    function openLivePreview(data){
      const d = data || sampleFused;
      const json = JSON.stringify(d);
      const bytes = new TextEncoder().encode(json);
      const b64 = btoa(Array.from(bytes, b => String.fromCharCode(b)).join(""));
      const url = `/preview.html#j=${b64}`;
      window.open(url, "_blank");
    }

    // Buttons
    document.getElementById("btn-run").addEventListener("click", runCrawlAndFuse);
    document.getElementById("btn-preview").addEventListener("click", ()=> openLivePreview(fused || sampleFused));

    // First paint
    renderPreview(sampleFused, sampleSocial);
  </script>
</body>
</html>
