<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jessica-SPZ • SporeZ Link Fusion</title>
  <style>
    :root{
      --bg:#0a0f14; --panel:#0f1620; --muted:#7e95ad;
      --line:#102534; --glow1:#00f0ff; --glow2:#00ff88; --white:#e8f1ff;
      --accent:#70ffe0; --danger:#ff4d6d; --ok:#66ff99;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:radial-gradient(1200px 800px at 50% -10%, #0e1824 0%, var(--bg) 60%);
      color:var(--white); font:14px/1.5 system-ui,Segoe UI,Roboto,Inter,Arial;
      display:flex; align-items:flex-start; justify-content:center;
    }
    .wrap{width:min(1200px,96vw); padding:24px 16px 32px}
    header{display:grid; gap:8px; place-items:center; text-align:center; margin-bottom:16px}
    h1{
      margin:0;
      font-size:26px; letter-spacing:.5px; text-transform:uppercase;
      background:linear-gradient(90deg,var(--glow1),var(--glow2));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-align:center;
    }
    .sub{color:var(--muted); text-align:center}
    .grid{
      display:grid;
      grid-template-columns: minmax(280px, 380px) 1fr;
      gap:16px;
      align-items:start;
    }
    .panel{
      background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.00));
      border:1px solid var(--line); border-radius:16px; padding:14px;
      box-shadow:0 0 0 1px rgba(0,0,0,.3), 0 10px 30px rgba(0,0,0,.35);
    }
    .panel h2{
      margin:0 0 10px; font-size:12px; font-weight:800; letter-spacing:.2px; text-transform:uppercase;
      color:var(--muted); text-align:center;
    }
    /* Left controls */
    .controls{display:grid; gap:10px; position:sticky; top:12px; max-height:calc(100vh - 24px); overflow:auto}
    textarea, input[type="text"]{
      width:100%; background:#0b121a; color:var(--white); border:1px solid #142131; border-radius:10px;
      padding:10px 12px; outline:none; font:13px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }
    textarea{min-height:120px; resize:vertical}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:center}
    .row > * { flex:1 1 auto }
    .btn{
      appearance:none; border:1px solid #143244; background:#0e1b26; color:var(--white);
      padding:10px 14px; border-radius:12px; font-weight:700; letter-spacing:.2px; cursor:pointer;
      transition:.18s transform ease,.18s box-shadow ease,.18s border-color ease; text-align:center;
    }
    .btn:hover{transform:translateY(-1px); box-shadow:0 8px 22px rgba(0,0,0,.35); border-color:#18465f}
    .btn.primary{background:linear-gradient(90deg,var(--glow1),var(--glow2)); color:#001b1f; border-color:transparent}
    .pill{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-size:12px;
      border:1px solid #173346; background:#0c1720; color:var(--muted); justify-content:center
    }
    .stack{display:grid; gap:10px}
    pre{
      margin:0; max-height:140px; overflow:auto; background:#071018; color:#bfe7ff;
      border:1px solid #0f2536; border-radius:10px; padding:10px; font-size:12px;
    }

    /* Right: device preview */
    .preview{display:grid; gap:12px}
    .preview-toolbar{
      display:flex; gap:8px; align-items:center; justify-content:space-between;
      border:1px solid var(--line); border-radius:12px; padding:8px 10px; background:#0c141caa;
    }
    .preview-toolbar .group{display:flex; gap:6px; align-items:center; flex-wrap:wrap}
    .chip{
      border:1px solid #143244; background:#0e1b26; color:var(--white);
      padding:6px 10px; border-radius:999px; font-size:12px; cursor:pointer;
    }
    .chip.is-active{background:linear-gradient(90deg,var(--glow1),var(--glow2)); color:#001b1f; border-color:transparent; font-weight:800}
    .iframe-wrap{
      display:flex; align-items:center; justify-content:center;
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));
      border:1px dashed #163044; border-radius:14px; padding:10px; min-height:480px;
    }
    .device{
      background:#0a0f14; border:1px solid #182738; border-radius:16px; box-shadow:0 18px 42px rgba(0,0,0,.45);
      overflow:hidden; width:100%; max-width:100%;
    }
    /* device sizes */
    .device.desktop{ width:100%; height:70vh; }
    .device.tablet { width:820px; max-width:100%; height:70vh; }
    .device.mobile { width:390px; max-width:100%; height:700px; }
    .device iframe{ border:0; width:100%; height:100%; background:#fff }
    @media (max-width:980px){ .grid{grid-template-columns:1fr} .device.desktop{ height:60vh } }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Jessica-SPZ — SporeZ Link Fusion</h1>
      <div class="sub">
        <span class="pill" id="sid-pill">Session: <b id="sid">…</b></span>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: Controls -->
      <section class="panel controls">
        <h2>Input Links</h2>
        <textarea id="links" placeholder="Paste 1 link per line"></textarea>

        <div class="row">
          <label class="pill"><input type="radio" name="mode" value="auto" checked />&nbsp;Auto</label>
          <label class="pill"><input type="radio" name="mode" value="sell" />&nbsp;Sell</label>
          <label class="pill"><input type="radio" name="mode" value="info" />&nbsp;Info</label>
          <label class="pill"><input type="radio" name="mode" value="hybrid" />&nbsp;Hybrid</label>
        </div>

        <div class="row">
          <label class="pill"><input type="checkbox" id="defSell" checked />&nbsp;Default: Sell product</label>
          <label class="pill"><input type="checkbox" id="defInfo" />&nbsp;Default: Show info</label>
        </div>

        <div class="row">
          <input id="slug" type="text" placeholder="slug (optional, e.g. my-drop)" />
        </div>

        <div class="row">
          <button class="btn primary" id="btn-run">Crawl + Fuse</button>
          <button class="btn" id="btn-preview">Preview</button>
          <button class="btn" id="btn-publish">Publish</button>
        </div>

        <div class="stack">
          <h2>Log</h2>
          <pre id="log">ready.</pre>
          <h2>Fused JSON</h2>
          <pre id="json">{}</pre>
        </div>
      </section>

      <!-- RIGHT: Device Preview (iframe) -->
      <section class="panel preview">
        <h2>Live Preview</h2>

        <div class="preview-toolbar">
          <div class="group">
            <button class="chip is-active" data-size="desktop">Desktop</button>
            <button class="chip" data-size="tablet">Tablet</button>
            <button class="chip" data-size="mobile">Mobile</button>
          </div>
          <div class="group">
            <button class="chip" id="btn-refresh">Refresh</button>
            <button class="chip" id="btn-open">Open Fullscreen</button>
          </div>
        </div>

        <div class="iframe-wrap">
          <div id="device" class="device desktop">
            <iframe id="previewFrame" src="about:blank" title="Jessica-SPZ Preview"></iframe>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // --- Session ID ---
    function getOrCreateSessionId() {
      try {
        const k = "spz_session_id";
        let v = sessionStorage.getItem(k);
        if (!v) { v = "spz_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,8); sessionStorage.setItem(k, v); }
        return v;
      } catch { return "spz_local_"+Date.now(); }
    }
    const SID = getOrCreateSessionId();
    document.getElementById("sid").textContent = SID;

    // --- UI refs ---
    const elLinks = document.getElementById("links");
    const elLog   = document.getElementById("log");
    const elJSON  = document.getElementById("json");
    const elSlug  = document.getElementById("slug");
    const elDevice = document.getElementById("device");
    const elFrame  = document.getElementById("previewFrame");

    const $ = (s) => document.querySelector(s);
    const getMode = () => (document.querySelector('input[name="mode"]:checked')?.value || "auto");
    const getDefaults = () => ({ sell: $('#defSell').checked, info: $('#defInfo').checked });

    function log(msg, isErr=false){
      elLog.textContent += "\n" + (isErr ? "⛔ " : "• ") + msg;
      elLog.scrollTop = elLog.scrollHeight;
    }

    async function postJSON(path, body){
      const res = await fetch(path, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body || {}) });
      if(!res.ok){ const t = await res.text().catch(()=> ""); throw new Error(`HTTP ${res.status} ${t}`); }
      return res.json();
    }

    // State
    let fused = {
      mode:"hybrid",
      slug:"sample-" + Date.now().toString(36),
      hero:{ title:"Zetsu-Grade Fusion Page", subtitle:"Auto-built from your links", image:"", ctaText:"Claim Your Drop", ctaLink:"#"},
      products:[
        {name:"Holo Tee", price:"$29", link:"#", description:"Shimmer print • Limited"},
        {name:"Z-Cap", price:"$19", link:"#", description:"Low-profile • Night mode"}
      ],
      articles:[
        {heading:"What This Page Does", content:"Jessica-SPZ crawls your links, extracts key info and products, and fuses it into a single, market-ready SporeZ page."}
      ],
      media:[]
    };

    function b64FromJSON(obj){
      const json = JSON.stringify(obj);
      const bytes = new TextEncoder().encode(json);
      return btoa(Array.from(bytes, b => String.fromCharCode(b)).join(""));
    }

    function loadIframe(data){
      const b64 = b64FromJSON(data);
      elFrame.src = `/preview.html#j=${b64}`;
    }

    async function runCrawlAndFuse(){
      try{
        elLog.textContent = "running…";
        const links = elLinks.value.split(/\n+/).map(s=>s.trim()).filter(Boolean);
        if(!links.length){ log("Add at least one link.", true); return; }

        log("Crawling links…");
        const crawl = await postJSON("/api/crawl", { links, session: SID });

        log("Fusing content…");
        fused = await postJSON("/api/fuse", { results: crawl.results || [], mode: getMode(), defaults: getDefaults(), session: SID });
        elJSON.textContent = JSON.stringify(fused, null, 2);
        log("Fusion complete.");

        loadIframe(fused);
      }catch(e){ log("Error: " + e.message, true); }
    }

    async function publish(){
      try{
        if(!fused){ log("Nothing fused yet.", true); return; }
        let slug = elSlug.value.trim();
        if(!slug){
          const base = (fused.hero?.title || "drop").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");
          slug = base || ("drop-" + Date.now().toString(36));
        }
        fused.slug = slug;

        log(`Publishing "${slug}"…`);
        const out = await postJSON("/api/publish_via_deploy", { fused, session: SID });
        if(out && out.url){
          log("Published: " + out.url);
          try{ navigator.clipboard?.writeText(out.url); }catch{}
          window.open(out.url, "_blank");
        }else{
          log("Publish complete (no URL returned).");
        }
      }catch(e){ log("Publish error: " + e.message, true); }
    }

    // Toolbar
    document.querySelectorAll('.chip[data-size]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.chip[data-size]').forEach(b=>b.classList.remove('is-active'));
        btn.classList.add('is-active');
        const size = btn.getAttribute('data-size');
        elDevice.className = `device ${size}`;
      });
    });
    document.getElementById('btn-refresh').addEventListener('click', ()=> loadIframe(fused));
    document.getElementById('btn-open').addEventListener('click', ()=>{
      const b64 = b64FromJSON(fused);
      window.open(`/preview.html#j=${b64}`, "_blank");
    });

    // Buttons
    document.getElementById("btn-run").addEventListener("click", runCrawlAndFuse);
    document.getElementById("btn-preview").addEventListener("click", ()=> loadIframe(fused));
    document.getElementById("btn-publish").addEventListener("click", publish);

    // First paint
    loadIframe(fused);
  </script>
</body>
</html>
